generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StaffRole {
  ADMIN
  CONSUL
}

enum ServiceKey {
  VISA
  ID_DOCS
  CITIZENSHIP
  NOTARY
}

enum SlotStatus {
  OPEN
  BOOKED
  BLOCKED
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  RESCHEDULED
  COMPLETED
  NO_SHOW
}

enum CaseStatus {
  NEW
  IN_REVIEW
  NEEDS_INFO
  APPROVED
  REJECTED
  DONE
}

enum ContentType {
  PAGE
  NEWS
}

enum PublishStatus {
  DRAFT
  PUBLISHED
}

model StaffUser {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  displayName  String
  role         StaffRole
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  createdSlots             AppointmentSlot[]   @relation("SlotCreatedBy")
  casesAssigned            Case[]              @relation("CaseAssignedTo")
  caseStatusHistoryChanges CaseStatusHistory[] @relation("CaseStatusHistoryChangedBy")
  caseNotesCreated         CaseNote[]          @relation("CaseNoteCreatedBy")
  contentItemsAuthored     ContentItem[]       @relation("ContentItemAuthor")
  auditLogs                AuditLog[]
}

model Service {
  id                  String     @id @default(cuid())
  key                 ServiceKey @unique
  isActive            Boolean    @default(true)
  acceptsAppointments Boolean    @default(true)
  defaultDurationMin  Int        @default(20)
  nameI18n            Json
  descriptionI18n     Json?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  slots    AppointmentSlot[]
  bookings Booking[]
}

model AppointmentSlot {
  id         String     @id @default(cuid())
  serviceId  String
  service    Service    @relation(fields: [serviceId], references: [id])
  startAtUtc DateTime
  endAtUtc   DateTime
  status     SlotStatus @default(OPEN)
  capacity   Int        @default(1)

  createdById String?
  createdBy   StaffUser? @relation("SlotCreatedBy", fields: [createdById], references: [id])

  booking Booking?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceId, startAtUtc])
  @@index([serviceId, startAtUtc])
}

model Booking {
  id        String  @id @default(cuid())
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  slotId String          @unique
  slot   AppointmentSlot @relation(fields: [slotId], references: [id])

  bookingCode String        @unique
  status      BookingStatus @default(CONFIRMED)

  applicantName  String
  applicantEmail String
  applicantPhone String?
  applicantNote  String?

  locale    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tokens BookingToken[]
  case   Case?
}

model BookingToken {
  id        String  @id @default(cuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([bookingId])
}

model Case {
  id        String  @id @default(cuid())
  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  status       CaseStatus @default(NEW)
  assignedToId String?
  assignedTo   StaffUser? @relation("CaseAssignedTo", fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  statusHistory CaseStatusHistory[]
  notes         CaseNote[]
}

model CaseStatusHistory {
  id     String @id @default(cuid())
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)

  fromStatus  CaseStatus?
  toStatus    CaseStatus
  changedById String
  changedBy   StaffUser   @relation("CaseStatusHistoryChangedBy", fields: [changedById], references: [id])

  createdAt DateTime @default(now())

  @@index([caseId, createdAt])
}

model CaseNote {
  id     String @id @default(cuid())
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)

  note        String
  createdById String
  createdBy   StaffUser @relation("CaseNoteCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
}

model ContentItem {
  id     String        @id @default(cuid())
  type   ContentType
  slug   String        @unique
  status PublishStatus @default(DRAFT)

  contentI18n Json

  publishedAt DateTime?
  authorId    String?
  author      StaffUser? @relation("ContentItemAuthor", fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Setting {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
}

model EmailOutbox {
  id        String   @id @default(cuid())
  toEmail   String
  subject   String
  bodyText  String
  bodyHtml  String?
  status    String   @default("PENDING")
  lastError String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id      String     @id @default(cuid())
  actorId String?
  actor   StaffUser? @relation(fields: [actorId], references: [id])

  action     String
  entityType String
  entityId   String?
  beforeJson Json?
  afterJson  Json?
  ip         String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([createdAt])
}
